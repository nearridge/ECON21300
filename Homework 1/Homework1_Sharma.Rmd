---
title: "Homework 1: Estimating Covid-19 Deaths"
author: "Neeraj Sharma"
date: "4/7/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Assignment

Please submit: the answers to the questions, your code, and your dataset.  The code you provide should reproduce your model.  All of these should be submitted via canvas.

The Governor of Illinois, J. B. Pritzker, has decided that a key input to public policy is knowing how many people will die from Covid-19 in the near future.  He has asked you to estimate the total number of official Covid-19 deaths that will be officially recorded in the state of Illinois by April 21 and by May 31.

To fulfill that request, you will need to assemble a data set, do estimation based on that data, and have some sort of theoretical model in your mind to extrapolate out to the future.

* Describe the data set that you chose to assemble and the rationale behind the choices you made in deciding what data to use.
* Describe the model(s) that you settled on for estimation. What was your logic for using that/those particular models?
* Provide an exact number which is your prediction for cumulative official Illinois Covid deaths through April 21
* Provide an exact number which is your prediction for cumulative official Illinois Covid deaths through May 31
* How did you get from the estimates in (2) to the predictions in (3) and (4)?
* You donâ€™t have to provide exact numbers, but discuss what you think the standard errors associated with your estimates might be, and your rationale for thinking those would be the standard errors.
* Make exactly one pretty picture/graph/slide that you would show to the Governor to allow him to easily understand what he should be expecting in terms of Covid deaths.

## Introduction

In December 2019, scientists in China reported the discovery of a novel coronavirus originating from a wild seafood and exotic animal market in the city of Wuhan, Hubei Provence, China. Over the subsequent months, the virus spread over the world, infecting individuals on all populated continents and in nearly every country.^[https://www.nytimes.com/article/coronavirus-timeline.html]  The assignment given is to provide a prediction of deaths that might occur by April 21 and by May 31 in the state of Illinois for consideration by JB Pritzker.

```{r Loading Packages, message=FALSE}
library(tidyverse)
library(readr)
library(curl)
library(modelr)
library(broom)
library(here)
library(lubridate)

# For security reasons, my personal API key is hidden. Permission to access Census/ACS data
# to reproduce my results can be granted here: https://api.census.gov/data/key_signup.html
library(tidycensus)
```

## Describe the data set that you chose to assemble and the rationale behind the choices you made in deciding what data to use.

I draw on [data](https://github.com/CSSEGISandData/COVID-19) provided by the Johns Hopkins Center for Systems Science and Engineering (CSSE). The CSSE provides detailed data on COVID cases in the United States all the way down to the City level. The CSSE stopped providing data for recoveries from COVID for the United States specifically as they found "no reliable data source reporting recovered cases for many countries, such as the US."^[https://github.com/CSSEGISandData/COVID-19/issues/1250#issuecomment-602271179]

```{r Building Cases Dataset, message=FALSE, warning=FALSE}
# Pulls in the most recent version of COVID 19 cases and deaths from CSSE github repo.
# Static (April 9) versions of both of these datasets  are saved in "Raw Data." 
cases_raw <- read_csv(curl("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv"))
deaths_raw <- read_csv(curl("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv"))

# Create tidy DFs of COVID data for IL only
cases_counties <- cases_raw %>%
  filter(Province_State == "Illinois") %>%
  select(-UID, -iso2, -iso3, -code3, -FIPS, -Lat, -Long_, -Combined_Key) %>%
  pivot_longer(c(-Admin2,  -Province_State, -Country_Region), names_to = "date", values_to = "cases") %>%
  mutate(date = as.Date(date, "%m/%d/%y"))

deaths_counties <- deaths_raw %>%
  filter(Province_State == "Illinois") %>%
  select(-UID, -iso2, -iso3, -code3, -FIPS, -Combined_Key, -Lat, -Long_) %>%
  pivot_longer(c(-Admin2, -Province_State, -Country_Region, -Population), names_to = "date", values_to = "deaths") %>%
  mutate(date = as.Date(date, "%m/%d/%y"))

# Summarizes data to reflect statewide trends
cases_IL<- cases_counties %>%
  group_by(date, Admin2, Province_State, Country_Region) %>%
  summarize(cases = sum(cases))

deaths_IL <- deaths_counties %>%
  group_by(date, Admin2, Province_State, Country_Region, Population) %>%
  summarize(deaths = sum(deaths))

# Group together cases and deaths
cases_deaths_IL <- left_join(cases_IL, deaths_IL) %>%
  pivot_longer(c(cases, deaths), names_to = "disease status", values_to = "count") %>%
  mutate(percapita = count/Population) %>%
  mutate(days_since_first_case = date - ymd("2020-01-24")) %>%
  mutate(days_since_sheltering = date - mdy("3/20/2020"))
```

```{r}
# Hospital data
# https://hifld-geoplatform.opendata.arcgis.com/datasets/6ac5e325468c4cb9b905f1728d6fbf0f_0?selectedAttribute=BEDS
# https://www.chicagobusiness.com/static/section/hospital-beds-database.html

# mobility data
#https://www.google.com/covid19/mobility/
#https://github.com/vitorbaptista/google-covid19-mobility-reports
#https://ai.googleblog.com/2019/11/new-insights-into-human-mobility-with.html
#https://www.nature.com/articles/s41467-019-12809-y

# date implemented social distancing in each county maybe?
# https://www.finra.org/rules-guidance/key-topics/covid-19/shelter-in-place

ACS_vars_18 <- load_variables(2018, "acs5", cache = TRUE) %>%
  rename(jdhfjkdfhgjkdfhgjkfdshgjdsfhgjfdshgjkdfhgjkfdghkjfdghjdfshgjsdfhgjkdfshgjkdfhgjfhdsgjksdhfjkghdsfjkghsdfkjghjksdfhgkjsd = concept)

brev <- load_variables(2018, "acs5", cache = TRUE) %>%
  filter(label == "Estimate!!Total") %>%
  rename(jdhfjkdfhgjkdfhgjkfdshgjdsfhgjfdshgjkdfhgjkfdghkjfdghjdfshgjsdfhgjkdfshgjkdfhgjfhdsgjksdhfjkghdsfjkghsdfkjghjksdfhgkjsd = concept)

# Collect demographic data on IL counties. 
medincome_county_IL <- get_acs(geography = "county", 
                               variables = c(`population-` = "B01003_001",
                                             `median_income-` = "B19013_001", 
                                             `num_hh-` = "B10063_001", 
                                             `num_hh_w_people_under18-` = "B11005_002",
                                             `num_hh_w_people_over60-` = "B11006_002", 
                                             num_owneroccupants_morethan1_per_room = "B25014_005", 
                                             num_owneroccupants_morethan15_per_room = "B25014_006",
                                             num_owneroccupants_morethan2_per_room = "B25014_007",
                                             num_renteroccupants_morethan1_per_room = "B25014_011",
                                             num_renteroccupants_morethan15_per_room = "B25014_012",
                                             num_renteroccupants_morethan2_per_room = "B25014_013",
                                             `pop_under18-` = "B09001_001",
                                             `enrolled_in_school-` = "B14001_002"), 
                               year = 2018, state = "Illinois", output = "wide") %>%
  rowwise() %>%
  mutate(`num_hh_morethan1_person_perroom-E` = sum(num_owneroccupants_morethan1_per_roomE + num_owneroccupants_morethan15_per_roomE + num_owneroccupants_morethan2_per_roomE + num_renteroccupants_morethan1_per_roomE + num_renteroccupants_morethan15_per_roomE + num_renteroccupants_morethan2_per_roomE)) %>%
  # aggregating error by square rooting the sum of squared errors
  mutate(`num_hh_morethan1_person_perroom-M` = sqrt(sum(num_owneroccupants_morethan1_per_roomM ^ 2 + num_owneroccupants_morethan15_per_roomM ^
                                                 2 + num_owneroccupants_morethan2_per_roomM ^ 2 + num_renteroccupants_morethan1_per_roomM ^
                                                 2 + num_renteroccupants_morethan15_per_roomM ^ 2 + num_renteroccupants_morethan2_per_roomM ^
                                                 2))) %>%
  select(-GEOID, -num_owneroccupants_morethan1_per_roomE, -num_owneroccupants_morethan15_per_roomE, -num_owneroccupants_morethan2_per_roomE, -num_renteroccupants_morethan1_per_roomE, -num_renteroccupants_morethan15_per_roomE, -num_renteroccupants_morethan2_per_roomE, -num_owneroccupants_morethan1_per_roomM, -num_owneroccupants_morethan15_per_roomM, -num_owneroccupants_morethan2_per_roomM, -num_renteroccupants_morethan1_per_roomM, -num_renteroccupants_morethan15_per_roomM, -num_renteroccupants_morethan2_per_roomM) %>%
  separate(NAME, into = c("Admin2", NA), sep = " County, Illinois") %>%
  pivot_longer(-Admin2, names_to = c("demographic_var", ".value"), names_sep = "-") %>%
  rename(estimate = E, MOE = M) %>% 
  arrange(-desc(Admin2))

full <- left_join(cases_deaths_IL, medincome_county_IL)

```

## Describe the model(s) that you settled on for estimation. What was your logic for using that/those particular models?

```{r}
regres <- glm(deaths ~ date, data = deaths_IL, family = gaussian)
summary(regres)
```


```{r}
ggplot(cases_deaths_IL %>% group_by(date, `disease status`) %>% summarise(count = sum(count)), aes(x = date, y = count, group = `disease status`, color = `disease status`)) +
  geom_line() +
  geom_smooth(method = "glm",
              method.args = list(family = "poisson"),
              se = FALSE)

ggplot(cases_counties, aes(x = date, y = cases, group = `Admin2`)) +
  geom_point() +
  labs(title = "County level cases of covid over time.") 

ggplot(cases_counties %>% filter(Admin2 != "Cook"), aes(x = date, y = cases, group = `Admin2`)) +
  geom_path() +
  labs(title = "County level cases of covid over time. Not including cook")
```
