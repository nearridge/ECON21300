---
title: "Homework 1: Estimating Covid-19 Deaths"
author: "Neeraj Sharma"
date: "4/7/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Assignment

Please submit: the answers to the questions, your code, and your dataset.  The code you provide should reproduce your model.  All of these should be submitted via canvas.

The Governor of Illinois, J. B. Pritzker, has decided that a key input to public policy is knowing how many people will die from Covid-19 in the near future.  He has asked you to estimate the total number of official Covid-19 deaths that will be officially recorded in the state of Illinois by April 21 and by May 31.

To fulfill that request, you will need to assemble a data set, do estimation based on that data, and have some sort of theoretical model in your mind to extrapolate out to the future.

* Describe the data set that you chose to assemble and the rationale behind the choices you made in deciding what data to use.
* Describe the model(s) that you settled on for estimation. What was your logic for using that/those particular models?
* Provide an exact number which is your prediction for cumulative official Illinois Covid deaths through April 21
* Provide an exact number which is your prediction for cumulative official Illinois Covid deaths through May 31
* How did you get from the estimates in (2) to the predictions in (3) and (4)?
* You donâ€™t have to provide exact numbers, but discuss what you think the standard errors associated with your estimates might be, and your rationale for thinking those would be the standard errors.
* Make exactly one pretty picture/graph/slide that you would show to the Governor to allow him to easily understand what he should be expecting in terms of Covid deaths.

## Introduction

In December 2019, scientists in China reported the discovery of a novel coronavirus originating from a wild seafood and exotic animal market in the city of Wuhan, Hubei Provence, China. Over the subsequent months, the virus spread over the world, infecting individuals on all populated continents and in nearly every country.^[https://www.nytimes.com/article/coronavirus-timeline.html]  The assignment given is to provide a prediction of deaths that might occur by April 21 and by May 31 in the state of Illinois for consideration by JB Pritzker.

```{r Loading Packages, message=FALSE}
library(tidyverse)
library(readr)
library(modelr)
library(broom)
library(here)
library(lubridate)
library(fable)

# For security reasons, my personal API key is hidden. Permission to access Census/ACS data
# to reproduce my results can be granted here: https://api.census.gov/data/key_signup.html
library(tidycensus)
```

## Describe the data set that you chose to assemble and the rationale behind the choices you made in deciding what data to use.

My dataset pulls together data from four sources spread across three general categories. The categories I analyze are:

1. COVID
   i. January 24, 2020 to March 16, 2020 -- Data on cases and deaths as reported by the [New York Times](https://github.com/nytimes/covid-19-data)  
   i. March 17, 2020 and onwards -- Data on cases, deaths, tested, and negative results from the [Illinois Department of Public Health](https://www.dph.illinois.gov/covid19/covid19-statistics)
1. Demographics
   i. County-level demographic data pulled from the 2018 5-year Census American Community Survery
      a) Population
      a) Population under 18
      a) Population enrolled in school
      a) Median Income 
      a) Number of Households
      a) Number of Households with people under 18
      a) Number of Households with people over 60
      a) Number of Overcrowded Households
1. Hospitals
   i. County-level capacity, load and utilization data aggregated to the county level from the [Illinois Health Facilities and Services Review Board](https://www2.illinois.gov/sites/hfsrb/InventoriesData/FacilityProfiles/Pages/default.aspx)

```{r Building Cases Dataset, message=FALSE, warning=FALSE}
# Pulls in dataset produced by dataset_creat.R
full <- read_csv("20200412_combined_covid_demos_hosp.csv") %>%
  mutate(per_capita_deaths = deaths/`population-E`) %>%
  mutate(`socialdistancing?` = if_else(date > as.Date("2020-03-20"), 1, 0))

# Note: April 21, 2020 is 88 days after the first IL COVID case was recorded on 2020-01-24
# Note: May 31, 2020 is is 128 days after the first IL COVID case was recorded on 2020-01-24
```

```{r}
# Hospital data
# https://hifld-geoplatform.opendata.arcgis.com/datasets/6ac5e325468c4cb9b905f1728d6fbf0f_0?selectedAttribute=BEDS
# https://www.chicagobusiness.com/static/section/hospital-beds-database.html

# mobility data
#https://www.google.com/covid19/mobility/
#https://github.com/vitorbaptista/google-covid19-mobility-reports
#https://ai.googleblog.com/2019/11/new-insights-into-human-mobility-with.html
#https://www.nature.com/articles/s41467-019-12809-y

# date implemented social distancing in each county maybe?
# https://www.finra.org/rules-guidance/key-topics/covid-19/shelter-in-place

```

## Describe the model(s) that you settled on for estimation. What was your logic for using that/those particular models?

```{r}
apr <- full %>%
  select(date, deaths, `socialdistancing?`) %>%
  group_by(date, `socialdistancing?`) %>%
  summarize(deaths = sum(deaths)) %>%
  ungroup() %>%
  filter(deaths != 0) %>%
  as_tsibble(index = date)

apr_regres <- model(apr, lm = TSLM(log(deaths) ~ date * `socialdistancing?`))

apr_regres %>% report()

ggplot(augment(apr_regres), aes(x = date)) +
  geom_line(aes(y = deaths, color = "Deaths")) +
  geom_line(aes(y = .fitted, color = "Fitted from Model")) +
  scale_y_log10()
```

```{r}
# Population of county over 100,000

apr_highpop <- full %>%
  filter(county %in% c("Cook", "DuPage","Lake", "Will", "Kane", "McHenry", "Winnebago", "Madison", "St. Clair", "Champaign", "Sangamon", "Peoria", "McLean", "Rock Island", "Tazewell", "Kendall", "Kankakee", "LaSalle", "Macon", "DeKalb")) %>%
  select(date, deaths, `socialdistancing?`) %>%
  group_by(date, `socialdistancing?`) %>%
  summarize(deaths = sum(deaths)) %>%
  ungroup() %>%
  filter(deaths != 0) %>%
  as_tsibble(index = date)

apr_highpop_regres <- model(apr_highpop, lm = TSLM(log(deaths) ~ date * `socialdistancing?`))

apr_highpop_regres %>% report()

ggplot(augment(apr_highpop_regres), aes(x = date)) +
  geom_line(aes(y = deaths, color = "Deaths")) +
  geom_line(aes(y = .fitted, color = "Fitted from Model")) +
  scale_y_log10()
```

```{r}
apr_lowpop <- full %>%
  filter(!(county %in% c("Cook", "DuPage","Lake", "Will", "Kane", "McHenry", "Winnebago", "Madison", "St. Clair", "Champaign", "Sangamon", "Peoria", "McLean", "Rock Island", "Tazewell", "Kendall", "Kankakee", "LaSalle", "Macon", "DeKalb"))) %>%
  select(date, deaths, `socialdistancing?`) %>%
  group_by(date, `socialdistancing?`) %>%
  summarize(deaths = sum(deaths)) %>%
  ungroup() %>%
  filter(deaths != 0) %>%
  as_tsibble(index = date)

apr_lowpop_regres <- model(apr_lowpop, lm = TSLM(log(deaths) ~ date * `socialdistancing?`))

apr_lowpop_regres %>% report()

ggplot(augment(apr_lowpop_regres), aes(x = date)) +
  geom_line(aes(y = deaths, color = "Deaths")) +
  geom_line(aes(y = .fitted, color = "Fitted from Model")) +
  scale_y_log10()
```

```{r}
test <- full %>% 
  select(county, date, cases, `population-E`) %>%
  filter(cases != 0)

test2 <- as_tsibble(test, index = date, key = county)

regres <- model(test2, tslm = TSLM(log(cases) ~ trend()))

augment(regres)

augment(regres) %>%
  filter(county != "Cook") %>%
  ggplot(aes(x = date)) +
  geom_line(aes(y = cases, group = county)) +
  geom_line(aes(y = .fitted, group = county, color= "Fitted"))



```

```{r}
forecast(model(test2 %>% group_by(date) %>% summarize(cases = sum(cases)), tslm = TSLM(log(cases) ~ date))) %>%
  autoplot(test2, level = NULL)
```


```{r}
ggplot(full %>% group_by(date) %>% summarise_at(c("cases", "deaths"), sum) %>% pivot_longer(-date, names_to = "disease status", values_to = "count"), aes(x = date, y = count, group = `disease status`, color = `disease status`)) +
  geom_line() +
  geom_smooth(method = "glm",
              method.args = list(family = "poisson"),
              se = FALSE) +
  annotate("segment", x = as.Date("2020-03-20"), xend = as.Date("2020-03-20"), y = 0, yend = 25000, colour = "grey") +
  annotate("text", x = as.Date("2020-03-05"), y = 24000, label = "Social Distancing Begins")


ggplot(full, aes(x = date, y = cases, group = `county`)) +
  geom_point() +
  labs(title = "County level cases of covid over time.") 

ggplot(full %>% filter(county != "Cook"), aes(x = date, y = cases, group = `county`)) +
  geom_path() +
  labs(title = "County level cases of covid over time. Not including cook")
```

```{r}
ggplot(full %>% group_by(days_since_first_case) %>% summarize_at(c("cases", "deaths", "population-E"), sum) %>% mutate(per_capita_deaths = deaths/`population-E`), aes(x = days_since_first_case, y = per_capita_deaths)) +
  geom_path() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"),
              se = FALSE, fullrange = TRUE)

ggplot(full %>% group_by(days_since_first_case) %>% summarize_at(c("cases", "deaths", "population-E"), sum) %>% mutate(per_capita_deaths = deaths/`population-E`), aes(x = days_since_first_case, y = per_capita_deaths)) +
  geom_path() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"),
              se = FALSE, fullrange = TRUE) +
  xlim(0, 88)
```
